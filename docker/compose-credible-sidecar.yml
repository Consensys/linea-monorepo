# Credible Layer Sidecar Service Extension
# This adds the Credible Layer sidecar to the Linea stack

include:
  - compose-tracing-v2.yml

services:
  assertion-da:
    image: ghcr.io/phylaxsystems/credible-sdk/assertion-da-dev:main
    container_name: assertion-da
    hostname: assertion-da
    profiles: ["credible", "l2"]
    restart: unless-stopped
    ports:
      - "5001:5001"
      - "9012:9012"
    environment:
      - RUST_LOG=info
      # DA envs
      - DB_PATH=/etc/credible/assertions
      - DA_LISTEN_ADDR=0.0.0.0:5001
      - DA_CACHE_SIZE=1000000
      - DA_PRIVATE_KEY=0xdd7e619d26d7eef795e3b5144307204f2f5d7d08298d04b926e874c6d9d43e75

      # Telemetry
      - OTEL_SERVICE_NAME=assertion-da
      - DA_LOG_LEVEL=info
      - DA_METRICS_ADDR=0.0.0.0:9012
      - TRACING_METRICS_PORT=9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp  # IMPORTANT: This is required for the assertion-da and solc to exchange code
    cap_drop:
      - ALL
    cap_add:
      - CAP_NET_BIND_SERVICE
      - CAP_DAC_OVERRIDE
    networks:
      linea:
        ipv4_address: 11.11.11.206

  # Credible Layer Sidecar (currently a dummy/placeholder implementation)
  credible-sidecar:
    container_name: credible-sidecar
    hostname: credible-sidecar
    image: ghcr.io/phylaxsystems/credible-sdk/sidecar:main
    profiles: ["credible", "l2"]
    depends_on:
      sequencer:
        condition: service_healthy

    # Command line arguments for the sidecar
    command:
      - "--chain.transport-url=http://0.0.0.0:9546"
      - "--chain.chain-block-time=1000"
      - "--ae.rpc_url=ws://sequencer:8546"
      - "--ae.rpc_da_url=http://assertion-da:5001"  # If you have assertion DA running
      - "--ae.oracle_contract=0x6dD3f12ce435f69DCeDA7e31605C02Bb5422597b"

    environment:
      # Tracing/metrics configuration (optional)
      - OTEL_SERVICE_NAME=credible-sidecar
      - TRACING_METRICS_PORT=9000

      # Chain configuration
      - CHAIN_RPC_URL=http://sequencer:8545
      - CHAIN_BLOCK_TIME=1000

      # Assertion executor configuration
      - AE_BLOCK_TIME_LIMIT=650
      - AE_ASSERTION_GAS_LIMIT=3000000
      - AE_RPC_STORE_URL=ws://sequencer:8546
      - AE_BLOCK_TAG=finalized

    ports:
      # RPC server (currently only responds to "ping" method)
      - "9546:9546"
      # Metrics port (if configured)
      - "9000:9000"

    restart: unless-stopped

    networks:
      linea:
        ipv4_address: 11.11.11.205
