# Credible Layer Sidecar Service Extension
# This adds the Credible Layer sidecar to the Linea stack

include:
  - compose-tracing-v2.yml

services:
  assertion-da:
    image: ghcr.io/phylaxsystems/credible-sdk/assertion-da-dev:main
    container_name: assertion-da
    hostname: assertion-da
    profiles: ["credible", "l2"]
    restart: unless-stopped
    ports:
      - "5001:5001"
      - "9012:9012"
    environment:
      - RUST_LOG=info
      # DA envs
      - DB_PATH=/etc/credible/assertions
      - DA_LISTEN_ADDR=0.0.0.0:5001
      - DA_CACHE_SIZE=1000000
      - DA_PRIVATE_KEY=0xdd7e619d26d7eef795e3b5144307204f2f5d7d08298d04b926e874c6d9d43e75
      # Telemetry
      - OTEL_SERVICE_NAME=assertion-da
      - DA_LOG_LEVEL=info
      - DA_METRICS_ADDR=0.0.0.0:9012
      - TRACING_METRICS_PORT=9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp  # IMPORTANT: This is required for the assertion-da and solc to exchange code
    cap_drop:
      - ALL
    cap_add:
      - CAP_NET_BIND_SERVICE
      - CAP_DAC_OVERRIDE
    networks:
      linea:
        ipv4_address: 11.11.11.206

  # Credible Layer Sidecar
  credible-sidecar:
    container_name: credible-sidecar
    hostname: credible-sidecar
    image: ghcr.io/phylaxsystems/credible-sdk/sidecar-linea:main
    profiles: ["credible", "l2"]
    depends_on:
      sequencer:
        condition: service_healthy
    # Command line arguments for the sidecar
    command:
      - "--transport.bind-addr=0.0.0.0:9546"
      - "--chain.chain-id=1337"
      - "--chain.rpc-url=http://sequencer:8545"
      - "--credible.indexer-rpc-url=ws://sequencer:8546"
      - "--credible.assertion-da-rpc-url=http://assertion-da:5001"  # If you have assertion DA running
      - "--credible.state-oracle=0x6dD3f12ce435f69DCeDA7e31605C02Bb5422597b"
      - "--credible.assertion-gas-limit=3000000"
      - "--credible.block-tag=latest"
    environment:
      - RUST_LOG=debug
      - OTEL_SERVICE_NAME=credible-sidecar
      - TRACING_METRICS_PORT=9000
    ports:
      # RPC server (currently only responds to "ping" method)
      - "9546:9546"
      # Metrics port (if configured)
      - "9000:9000"
    restart: unless-stopped
    networks:
      linea:
        ipv4_address: 11.11.11.205

  credible-contract-deployer:
    container_name: credible-contract-deployer
    hostname: credible-contract-deployer
    image: ghcr.io/phylaxsystems/credible-layer-contracts/contracts-utils-linea:linea
    profiles: ["credible", "l2"]
    depends_on:
      sequencer:
        condition: service_healthy
    command:
    - bash
    - -c
    - |
      echo "### Credible contracts deployment! ###";

      while true; do
          echo "Attempting to connect to: $$RPC_URL"
          
          if cast chain-id --rpc-url "$$RPC_URL" 2>/dev/null; then
              echo "Sequencer RPC is responding!"
              break
          else
              echo "RPC not ready yet..."
              sleep 5
          fi
      done

      echo "Funding deployer..."
      cast send --private-key "$$FUNDER_PRIVATE_KEY" --rpc-url "$$RPC_URL" --value 2ether 0x8d63e0FE87CA36E06a076584fCA651A684D4c97d

      echo "Funding CreateX deployer..."
      cast send --private-key "$$PRIVATE_KEY" --rpc-url "$$RPC_URL" --value 0.5ether 0xeD456e05CaAb11d66C4c797dD6c1D6f9A7F352b5

      createxCode=$(cast code 0xba5Ed099633D3B313e4D5F7bdc1305d3c28ba5Ed --rpc-url "$$RPC_URL")

      if [ "$$createxCode" == "0x" ]; then
          echo "CreateX not deployed, deploying...";
          cast publish "$(cat "shell/presigned-transactions/createx_deploy_tx.json")" --rpc-url "$$RPC_URL"
      else
          echo "CreateX deployed, skipping deployment";
      fi
      
      echo "Deploying Credible Layer contracts"!
      forge script script/DeployCore.s.sol --rpc-url "$$RPC_URL" --broadcast --private-key "$$PRIVATE_KEY"
    environment:
      # This key is just to send some funds to the deployer pk (taken from the L2 genesis)
      FUNDER_PRIVATE_KEY: "0x75b9700016469b0d7f12c0d6a0225cd9a59818a4bd1437cf9583ca0ffa1d111a"
      # Deployer of the credible contracts
      PRIVATE_KEY: "0xac431098061ca49f5b36121d01a17d30e1d0624227d08b583ff328f1efe0d4a2"
      RPC_URL: "http://sequencer:8545"
      STATE_ORACLE_MAX_ASSERTIONS_PER_AA: 10
      STATE_ORACLE_ASSERTION_TIMELOCK_BLOCKS: 10
      STATE_ORACLE_ADMIN_ADDRESS: "0x8d63e0FE87CA36E06a076584fCA651A684D4c97d"
      # Must match the above assertion-da private key
      DA_PROVER_ADDRESS: "0xb0d60c09103F4a5c04EE8537A22ECD6a34382B36"
    restart: on-failure:3
    networks:
      linea:
