name: Slack Notification

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      title:
        description: "Notification title"
        required: true
        type: string
      failed_jobs:
        description: "Newline-separated list of failed jobs"
        required: false
        type: string
        default: ""
      run_url:
        description: "GitHub Actions run URL"
        required: true
        type: string
      repo:
        description: "Repository name"
        required: true
        type: string
      pr_number:
        description: "PR number if PR, empty otherwise"
        required: false
        type: string
        default: ""
      pr_url:
        description: "PR URL if PR, fallback to commit URL"
        required: true
        type: string
      commit_sha:
        description: "Commit SHA"
        required: true
        type: string
      commit_url:
        description: "Commit URL"
        required: true
        type: string
      author:
        description: "Commit or PR author login"
        required: true
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch job list
        id: jobs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ inputs.repo }}/actions/runs/${{ github.run_id }}/jobs \
            > jobs.json

          echo "json<<EOF" >> $GITHUB_OUTPUT
          cat jobs.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Extract failed job URLs
        id: build_urls
        env:
          FAILED_JOBS: "${{ inputs.failed_jobs }}"
        run: |
          echo "$FAILED_JOBS" | sed 's/^- //' | sed '/^$/d' > failed.txt

          echo "urls<<EOF" >> $GITHUB_OUTPUT

          while read -r job; do
            url=$(jq -r --arg NAME "$job" '.jobs[] | select(.name==$NAME) | .html_url' <<< "${{ steps.jobs.outputs.json }}")
            if [[ "$url" != "null" && -n "$url" ]]; then
              echo "- <$url|$job>" >> $GITHUB_OUTPUT
            else
              echo "- $job (url not found)" >> $GITHUB_OUTPUT
            fi
          done < failed.txt

          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a #v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: ":x: GitHub CI for *${{ inputs.repo }}* â€” *${{ inputs.title }}*"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: ":x: ${{ inputs.title }}"
                  emoji: true

              - type: section
                fields:
                  - type: mrkdwn
                    text: "*Repository:*\n${{ inputs.repo }}"
                  - type: mrkdwn
                    text: "*Status:*\n${{ inputs.status }}"

              - type: section
                fields:
                  - type: mrkdwn
                    text: "*Author:*\n${{ inputs.author }}"
                  - type: mrkdwn
                    text: "*Commit:*\n<${{ inputs.commit_url }}|${{ inputs.commit_sha }}>"

              - type: section
                fields:
                  - type: mrkdwn
                    text: "*Run:* \n<${{ inputs.run_url }}|Open GitHub Run>"
                  - type: mrkdwn
                    text: "*Details:* \n<${{ inputs.pr_url }}|${{ inputs.pr_number != '' && format('PR #%s', inputs.pr_number) || 'Commit' }}>"

              - type: section
                text:
                  type: mrkdwn
                  text: |
                    *Failed Jobs:*
                    ${{ inputs.failed_jobs != '' && inputs.failed_jobs || 'None' }}

