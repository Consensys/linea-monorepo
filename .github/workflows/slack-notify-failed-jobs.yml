name: slack-notify-failed-jobs

permissions:
  contents: read
  actions: read

on:
  workflow_call:
    inputs:
      title:
        description: "Notification title"
        required: true
        type: string
      run_id:
        description: "GitHub Actions Run ID"
        required: true
        type: string
      extra_message:
        description: "Optional extra context"
        required: false
        default: ""
        type: string
    secrets:
      channel_id:
        description: "Slack channel ID (from secrets)"
        required: true
      slack_bot_token:
        description: "Slack bot token for posting messages"
        required: true

jobs:
  notify:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-small

    steps:
      - name: Compute context values
        id: ctx
        shell: bash
        run: |
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT

          # PR number or empty
          echo "pr_number=${{ github.event.pull_request.number || '' }}" >> $GITHUB_OUTPUT

          # PR URL or commit URL fallback
          echo "pr_url=${{ github.event.pull_request.html_url || github.event.head_commit.url }}" >> $GITHUB_OUTPUT

          # Commit SHA (PR head SHA or push SHA)
          echo "commit_sha=${{ github.event.pull_request.head.sha || github.sha }}" >> $GITHUB_OUTPUT

          # Commit URL
          if [[ -n "${{ github.event.head_commit.url }}" ]]; then
            echo "commit_url=${{ github.event.head_commit.url }}" >> $GITHUB_OUTPUT
          elif [[ -n "${{ github.event.pull_request.head.sha }}" ]]; then
            echo "commit_url=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "commit_url=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

          # Author (PR author or commit author or github.actor)
          echo "author=${{ github.event.pull_request.user.login || github.event.head_commit.author.username || github.actor }}" >> $GITHUB_OUTPUT

      - name: Fetch job list
        id: jobs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ steps.ctx.outputs.repo }}/actions/runs/${{ inputs.run_id }}/jobs \
            > jobs.json

          echo "json<<EOF" >> $GITHUB_OUTPUT
          cat jobs.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract failed and cancelled jobs
        id: extract_jobs
        shell: bash
        env:
          JOBS_JSON: "${{ steps.jobs.outputs.json }}"
        run: |
          set -euo pipefail

          extract_jobs() {
            local conclusion="$1"
            printf "%s" "$JOBS_JSON" | jq -c --arg c "$conclusion" '
              [
                .jobs[]
                | select(.conclusion == $c)
                | {
                    type: "rich_text_section",
                    elements: [
                      { type: "text", text: (.name + ": ") },
                      { type: "link", url: .html_url, text: .html_url }
                    ]
                  }
              ]
            '
          }

          failed=$(extract_jobs "failure")
          cancelled=$(extract_jobs "cancelled")

          set_output() {
            local name="$1" value="$2"
            if [[ "$value" == "[]" ]]; then
              echo "${name}=" >> "$GITHUB_OUTPUT"
            else
              echo "${name}<<EOF" >> "$GITHUB_OUTPUT"
              echo "$value" >> "$GITHUB_OUTPUT"
              echo "EOF" >> "$GITHUB_OUTPUT"
            fi
          }

          set_output "failed" "$failed"
          set_output "cancelled" "$cancelled"

          if [[ "$failed" == "[]" && "$cancelled" == "[]" ]]; then
            echo "has_results=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_results=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build job sections
        id: job_sections
        if: ${{ steps.extract_jobs.outputs.has_results == 'true' }}
        shell: bash
        env:
          FAILED: "${{ steps.extract_jobs.outputs.failed }}"
          CANCELLED: "${{ steps.extract_jobs.outputs.cancelled }}"
        run: |
          set -euo pipefail

          build_section() {
            local label="$1" items="$2"
            jq -n -c --arg label "$label" --argjson items "$items" '{
              type: "rich_text",
              elements: [
                {
                  type: "rich_text_section",
                  elements: [
                    { type: "text", text: $label, style: { bold: true } }
                  ]
                },
                {
                  type: "rich_text_list",
                  style: "bullet",
                  elements: $items
                }
              ]
            }'
          }

          if [[ -n "$FAILED" ]]; then
            block=$(build_section "Failed Jobs:" "$FAILED")
            echo "failed_section=- ${block}" >> "$GITHUB_OUTPUT"
          else
            echo "failed_section=" >> "$GITHUB_OUTPUT"
          fi

          if [[ -n "$CANCELLED" ]]; then
            block=$(build_section "Cancelled Jobs:" "$CANCELLED")
            echo "cancelled_section=- ${block}" >> "$GITHUB_OUTPUT"
          else
            echo "cancelled_section=" >> "$GITHUB_OUTPUT"
          fi

      - name: Build extra block
        id: extra_block
        if: ${{ steps.extract_jobs.outputs.has_results == 'true' }}
        shell: bash
        env:
          EXTRA_MESSAGE: "${{ inputs.extra_message }}"
        run: |
          if [[ -n "${EXTRA_MESSAGE}" ]]; then
            block=$(jq -n -c --arg msg "$EXTRA_MESSAGE" '{
              type: "rich_text",
              elements: [{
                type: "rich_text_section",
                elements: [
                  { type: "text", text: "Message: ", style: { bold: true } },
                  { type: "text", text: $msg }
                ]
              }]
            }')
            echo "block<<EOF" >> "$GITHUB_OUTPUT"
            echo "- $block" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "block=" >> "$GITHUB_OUTPUT"
          fi

      - name: Send Slack Notification
        if: ${{ steps.extract_jobs.outputs.has_results == 'true' }}
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a #v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.slack_bot_token }}
          payload: |
            channel: ${{ secrets.channel_id }}
            text: ":x: GitHub CI for *${{ steps.ctx.outputs.repo }}* â€” *${{ inputs.title }}*"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: ":x: ${{ inputs.title }}"
                  emoji: true
              
              - type: rich_text
                elements:
                  - type: rich_text_section
                    elements:
                      - type: text
                        text: "Repository: "
                        style:
                          bold: true
                      - type: text
                        text: "${{ steps.ctx.outputs.repo }}"
              
              - type: rich_text
                elements:
                  - type: rich_text_section
                    elements:
                      - type: text
                        text: "Author: "
                        style:
                          bold: true
                      - type: text
                        text: "${{ steps.ctx.outputs.author }}"

              - type: rich_text
                elements:
                  - type: rich_text_section
                    elements:
                      - type: text
                        text: "Commit: "
                        style:
                          bold: true
                      - type: link
                        url: "${{ steps.ctx.outputs.commit_url }}"
                        text: "${{ steps.ctx.outputs.commit_sha }}"

              ${{ steps.job_sections.outputs.failed_section }}
              ${{ steps.job_sections.outputs.cancelled_section }}
              ${{ steps.extra_block.outputs.block }}