name: slack-failed-jobs-notification

permissions:
  contents: read
  actions: read

on:
  workflow_call:
    inputs:
      title:
        description: "Notification title"
        required: true
        type: string
      run_id:
        description: "GitHub Actions Run ID"
        required: true
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Compute context values
        id: ctx
        shell: bash
        run: |
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT

          # PR number or empty
          echo "pr_number=${{ github.event.pull_request.number || '' }}" >> $GITHUB_OUTPUT

          # PR URL or commit URL fallback
          echo "pr_url=${{ github.event.pull_request.html_url || github.event.head_commit.url }}" >> $GITHUB_OUTPUT

          # Commit SHA (PR head SHA or push SHA)
          echo "commit_sha=${{ github.event.pull_request.head.sha || github.sha }}" >> $GITHUB_OUTPUT

          # Commit URL
          echo "commit_url=${{ github.event.head_commit.url || format('%s/%s/commit/%s', github.server_url, github.repository, github.sha) }}" >> $GITHUB_OUTPUT

          # Author (PR author or commit author or github.actor)
          echo "author=${{ github.event.pull_request.user.login || github.event.head_commit.author.username || github.actor }}" >> $GITHUB_OUTPUT

      - name: Fetch job list
        id: jobs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ steps.ctx.outputs.repo }}/actions/runs/${{ inputs.run_id }}/jobs \
            > jobs.json

          echo "json<<EOF" >> $GITHUB_OUTPUT
          cat jobs.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Group failed jobs dynamically
        id: grouped_failed
        shell: bash
        env:
          JOBS_JSON: "${{ steps.jobs.outputs.json }}"
        run: |
          set -euo pipefail

          # Suffix words (case-insensitive)
          suffixes=( test tests testing build ci e2e )

          # ASCII Unit Separator (safe in CI and macOS)
          SEP=$'\x1f'

          # Reset associative array
          unset GROUPS
          declare -A GROUPS

          #
          # Read job name + url pairs using process substitution
          #
          while IFS="$SEP" read -r name url; do

          #
          # --- PREFIX EXTRACTION ---
          # Convert "-" → " ", split into array
          #
          tmp="${name//-/ }"
          read -ra words <<< "$tmp"

          # Strip all trailing suffix words (case-insensitive)
          while [[ ${#words[@]} -gt 0 ]]; do
            last="$(tr '[:upper:]' '[:lower:]' <<< "${words[-1]}")"
            match=false
            for s in "${suffixes[@]}"; do
              if [[ "$last" == "$s" ]]; then
                unset 'words[-1]'
                match=true
                break
              fi
            done
            [[ "$match" == false ]] && break
          done

          # Rebuild prefix or fall back to full name
          if [[ ${#words[@]} -eq 0 ]]; then
            prefix="$name"
          else
            prefix="${words[*]}"
          fi

          # Add job to its group
          GROUPS["$prefix"]+="- <$url|$name>\n"

          done < <(
            jq -r --arg sep "$SEP" '
              .jobs[]
              | select(.conclusion == "failure")
              | "\(.name)\($sep)\(.html_url)"
            ' <<< "$JOBS_JSON"
          )

          #
          # No failed jobs? Output "None"
          #
          if [[ ${#GROUPS[@]} -eq 0 ]]; then
            echo "grouped<<EOF" >> $GITHUB_OUTPUT
            echo "None" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          #
          # Build Slack-formatted grouped output
          #
          output=""
          for prefix in "${!GROUPS[@]}"; do
            output+="*${prefix^}:*\n${GROUPS[$prefix]}\n"
          done

          echo "grouped<<EOF" >> $GITHUB_OUTPUT
          printf "%b" "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Slack Notification
        if: ${{ steps.grouped_failed.outputs.grouped != 'None' }}
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a #v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_GITHUB_ACTIONS_ALERTS_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_ENGINEERING_ALERTS_CHANNEL_ID }}
            text: ":x: GitHub CI for *${{ steps.ctx.outputs.repo }}* — *${{ inputs.title }}*"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: ":x: ${{ inputs.title }}"
                  emoji: true

              - type: section
                fields:
                  - type: mrkdwn
                    text: "*Repository:*\n${{ steps.ctx.outputs.repo }}"
                  - type: mrkdwn
                    text: "*Author:*\n${{ steps.ctx.outputs.author }}"

              - type: section
                fields:
                  - type: mrkdwn
                    text: "*Commit:*\n<${{ steps.ctx.outputs.commit_url }}|${{ steps.ctx.outputs.commit_sha }}>"

              - type: section
                text:
                  type: mrkdwn
                  text: "*Failed Job URLs:*\n${{ steps.grouped_failed.outputs.grouped }}"
