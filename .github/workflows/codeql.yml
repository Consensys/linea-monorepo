name: CodeQL

on:
  workflow_call:

jobs:
  changes:
    name: Detect Changes
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-small
    outputs:
      languages: ${{ steps.set-matrix.outputs.languages }}
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 #v3.0.2
        id: changes
        with:
          filters: |
            go:
              - '**/*.go'
              - '**/go.mod'
              - '**/go.sum'
            java-kotlin:
              - '**/*.java'
              - '**/*.kt'
              - '**/*.gradle'
              - '**/*.gradle.kts'
              - '**/pom.xml'
              - '**/build.gradle'
              - '**/gradle.properties'
              - '**/settings.gradle'
              - 'build.gradle'
              - 'gradle.properties'
              - 'settings.gradle'
            javascript-typescript:
              - '**/*.js'
              - '**/*.ts'
              - '**/*.tsx'
              - '**/*.jsx'
              - '**/*.json'
              - '**/package.json'
              - '**/tsconfig.json'
              - '**/pnpm-lock.yaml'
              - '**/yarn.lock'
              - '**/package-lock.json'
            actions:
              - '.github/workflows/**'
              - '.github/actions/**'
            python:
              - '**/*.py'
              - '**/requirements.txt'
              - '**/pyproject.toml'
              - '**/setup.py'
      
              - '**/Pipfile'
      - name: Build matrix
        id: set-matrix
        run: |
          langs=()

          [[ "${{ steps.changes.outputs.go }}" == "true" ]] && langs+=("go")
          [[ "${{ steps.changes.outputs.java-kotlin }}" == "true" ]] && langs+=("java-kotlin")
          [[ "${{ steps.changes.outputs.javascript-typescript }}" == "true" ]] && langs+=("javascript-typescript")
          [[ "${{ steps.changes.outputs.actions }}" == "true" ]] && langs+=("actions")
          [[ "${{ steps.changes.outputs.python }}" == "true" ]] && langs+=("python")

          json=$(printf '%s\n' "${langs[@]}" | jq -R . | jq -s .)
          echo "languages=$json" >> $GITHUB_OUTPUT

  analyze:
    name: Analyze
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-med
    needs: changes
    if: ${{ needs.changes.outputs.languages != '[]' }}
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJson(needs.changes.outputs.languages) }}

    steps:
      - name: Skip if no changes
        run: echo "Skipping ${{ matrix.language }} - no relevant changes detected"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Setup Java
        if: matrix.language == 'java-kotlin'
        uses: actions/setup-java@8df1039502a15bceb9433410b1a100fbe190c53b #v4.5.0
        with:
          distribution: temurin
          java-version: 21

      - name: Autobuild
        if: matrix.language != 'actions'
        uses: github/codeql-action/autobuild@v3
        env:
          GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN_RELEASE_ACCESS }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"
          output: sarif-results

      - name: Upload CodeQL Results
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results-${{ matrix.language }}
          path: sarif-results
          retention-days: 1
