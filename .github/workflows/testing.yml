name: Testing CI

permissions:
  contents: read
  actions: read

on:
  workflow_call:
    inputs:
      commit_tag:
        required: true
        type: string
      coordinator_changed:
        required: true
        type: string
      staterecovery_changed:
        required: true
        type: string
      native_yield_automation_service_changed:
        required: true
        type: string
      postman_changed:
        required: true
        type: string
      prover_changed:
        required: true
        type: string
      transaction_exclusion_api_changed:
        required: true
        type: string
      smart_contracts_changed:
        required: true
        type: string
      linea_sequencer_changed:
        required: true
        type: string
      tracer_changed:
        required: true
        type: string
      constraints_changed:
        required: true
        type: string

jobs:
  # Cache for pulling Docker images is disabled as we empirically found that this
  # (retrieving cache and loading Docker images) actually increased test time-to-completion
  coordinator:
    uses: ./.github/workflows/coordinator-testing.yml
    if: ${{ inputs.coordinator_changed == 'true' }}
    with:
      commit_tag: ${{ inputs.commit_tag }}
    secrets: inherit

  prover:
    uses: ./.github/workflows/prover-testing.yml
    if: ${{ inputs.prover_changed == 'true' }}
    secrets: inherit

  native-yield-automation-service:
    uses: ./.github/workflows/native-yield-automation-service-testing.yml
    if: ${{ inputs.native_yield_automation_service_changed == 'true' }}
    secrets: inherit

  postman:
    uses: ./.github/workflows/postman-testing.yml
    if: ${{ inputs.postman_changed == 'true' }}
    secrets: inherit

  transaction-exclusion-api:
    uses: ./.github/workflows/transaction-exclusion-api-testing.yml
    if: ${{ inputs.transaction_exclusion_api_changed == 'true' }}
    secrets: inherit

  staterecovery:
    uses: ./.github/workflows/staterecovery-testing.yml
    if: ${{ inputs.staterecovery_changed == 'true' }}
    with:
      commit_tag: ${{ inputs.commit_tag }}
    secrets: inherit

  smart-contracts:
    uses: ./.github/workflows/run-smc-tests.yml
    if: ${{ inputs.smart_contracts_changed == 'true' }}
    with:
      commit_tag: ${{ inputs.commit_tag }}
    secrets: inherit

  linea-sequencer:
    uses: ./.github/workflows/linea-sequencer-plugin-testing.yml
    if: ${{ inputs.linea_sequencer_changed == 'true' }}
    secrets: inherit

  # tracer:
  #   uses: ./.github/workflows/tracer-gradle-tests.yml
  #   if: ${{ inputs.tracer_changed == 'true' }}
  #   secrets: inherit

  constraints:
    uses: ./.github/workflows/tracer-constraints-check-compilation.yml
    if: ${{ inputs.constraints_changed == 'true' }}
    secrets: inherit

  # Run Jacoco report after all JVM tests complete
  jacoco-report:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-med
    name: Generate Jacoco Coverage Report
    # Run if at least one JVM test job completed (whether passed, failed, or cancelled)
    # Don't run if all test jobs were skipped due to no changes
    if: |
      always() && (
        needs.coordinator.result != 'skipped' ||
        needs.linea-sequencer.result != 'skipped' ||
        needs.staterecovery.result != 'skipped' ||
        needs.transaction-exclusion-api.result != 'skipped'
      )
    needs:
      - coordinator
      - linea-sequencer
      - staterecovery
      - transaction-exclusion-api
    env:
      COMMIT_TAG: ${{ inputs.commit_tag }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Tracer Environment # configures Go, Java, Gradle, and gets submodules
        uses: ./.github/actions/setup-tracer-environment
        with:
          enable-ssh: false

      - name: Download Jacoco execution data from coordinator
        if: needs.coordinator.result != 'skipped'
        uses: actions/download-artifact@v7
        with:
          name: jacoco-coordinator-exec
          path: .
      - name: Download Jacoco execution data from linea-sequencer unit tests
        if: needs.linea-sequencer.result != 'skipped'
        uses: actions/download-artifact@v7
        with:
          name: jacoco-linea-sequencer-unit-exec
          path: .
      - name: Download Jacoco execution data from linea-sequencer acceptance tests
        if: needs.linea-sequencer.result != 'skipped'
        uses: actions/download-artifact@v7
        with:
          name: jacoco-linea-sequencer-acceptance-exec
          path: .
      - name: Download Jacoco execution data from staterecovery
        if: needs.staterecovery.result != 'skipped'
        uses: actions/download-artifact@v7
        with:
          name: jacoco-staterecovery-exec
          path: .
      - name: Download Jacoco execution data from transaction-exclusion-api
        if: needs.transaction-exclusion-api.result != 'skipped'
        uses: actions/download-artifact@v7
        with:
          name: jacoco-transaction-exclusion-api-exec
          path: .

      - name: Run Jacoco Root Report
        run: |
          ./gradlew jacocoRootReport
      - name: Upload Jacoco test coverage report
        uses: actions/upload-artifact@v4
        with:
          name: jacocoRootReport-${{ env.COMMIT_TAG }}.xml
          if-no-files-found: error
          path: |
            ${{ github.workspace }}/build/reports/jacoco/jacocoRootReport/jacocoRootReport.xml
      - name: Upload coverage to Codecov
        if: ${{ env.CODECOV_TOKEN != '' }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de #v5.5.2
        with:
          fail_ci_if_error: true
          files: ${{ github.workspace }}/build/reports/jacoco/jacocoRootReport/jacocoRootReport.xml
          flags: kotlin
          os: linux
          name: codecov-jvm-tests
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

  # If all jobs are skipped, the workflow will still succeed.
  always_succeed:
    runs-on: ubuntu-24.04
    if: ${{ inputs.coordinator_changed == 'false' && inputs.prover_changed == 'false' && inputs.native_yield_automation_service_changed == 'false' && inputs.postman_changed == 'false' && inputs.transaction_exclusion_api_changed == 'false' && inputs.staterecovery_changed == 'false' && inputs.smart_contracts_changed == 'false' && inputs.linea_sequencer_changed == 'false' && inputs.constraints_changed == 'false' }}
    steps:
      - name: Ensure Workflow Success
        run: echo "All jobs were skipped, but workflow succeeds."
