name: linea-sequencer-plugin-release

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version'
        required: true
        type: string

jobs:
  build:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-small
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@8df1039502a15bceb9433410b1a100fbe190c53b #v4.5.0
        with:
          java-version: 21
          distribution: temurin
          cache: 'gradle'

      - name: Build artifacts
        run: ./gradlew besu-plugins:linea-sequencer:sequencer:artifacts -PreleaseVersion=${{ github.event.inputs.version }}
        env:
          JAVA_OPTS: -Xmx2g -Dorg.gradle.daemon=false

      - name: Create draft release with uploaded assets
        id: create_draft_release
        # v1.16.0
        uses: ncipollo/release-action@440c8c1cb0ed28b9f43e4d1d670870f059653174
        with:
          name: "Linea Sequencer ${{ github.event.inputs.version }}"
          artifacts: "./besu-plugins/linea-sequencer/sequencer/build/libs/linea-sequencer-${{ github.event.inputs.version }}.jar,./besu-plugins/linea-sequencer/sequencer/build/distributions/linea-sequencer-${{ github.event.inputs.version }}.zip"
          artifactErrorsFailBuild: true
          artifactContentType: application/octet-stream
          generateReleaseNotes: true
          tag: linea-sequencer-${{ github.event.inputs.version }}
          commit: ${{ github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: true
          allowUpdates: true
          updateOnlyUnreleased: true

      - name: Log GitHub Release URL
        shell: bash
        run: |
          echo "Draft release URL: ${{ steps.create_draft_release.outputs.html_url }}"