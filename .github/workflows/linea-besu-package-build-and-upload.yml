name: linea-besu-package-build-and-upload

permissions:
  contents: read
  actions: read
  packages: read

on:
  workflow_call:
    inputs:
      release_tag_prefix:
        required: true
        type: string
      with_besu_fleet_plugin:
        required: true
        type: boolean
      build_from_source:
        description: 'When "true", build tracer and sequencer zips from source (using besu/arithmetization from releases.versions.toml) and assemble with local zips; used when releases.versions.toml besu/arithmetization changed'
        required: true
        type: boolean
    outputs:
      linea_besu_package_tag:
        value: ${{ jobs.build-and-upload-artifact.outputs.linea_besu_package_tag }}
      expected_traces_api_version:
        value: ${{ jobs.build-and-upload-artifact.outputs.expected_traces_api_version }}
      dockerimage:
        value: ${{ jobs.build-and-upload-artifact.outputs.dockerimage }}
    secrets:
      DOCKERHUB_USERNAME:
        required: false
      DOCKERHUB_TOKEN:
        required: false
      FLEET_GITHUB_APP_ID:
        required: false
      FLEET_GITHUB_APP_PRIVATE_KEY:
        required: false

jobs:
  build-and-upload-artifact:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-med
    outputs:
      linea_besu_package_tag: ${{ steps.assemble.outputs.dockertag }}
      expected_traces_api_version: ${{ steps.assemble.outputs.tracer_plugin_version }}
      dockerimage: ${{ steps.assemble.outputs.dockerimage }}
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Parse release versions from releases.versions.toml if build from source
        if: ${{ inputs.build_from_source }}
        id: release_versions
        uses: ./.github/actions/parse-release-versions
      
      - name: Setup Tracer Environment (build from source)
        if: ${{ inputs.build_from_source }}
        uses: ./.github/actions/setup-tracer-environment
        with:
          enable-ssh: false

      - name: Build tracer zip from source
        if: ${{ inputs.build_from_source }}
        run: ./gradlew :tracer:artifacts -PreleaseVersion=${{ steps.release_versions.outputs.arithmetization_version }}
        env:
          JAVA_OPTS: -Xmx2g -Dorg.gradle.daemon=false

      - name: Build sequencer zip from source
        if: ${{ inputs.build_from_source }}
        run: ./gradlew besu-plugins:linea-sequencer:sequencer:artifacts -PreleaseVersion=${{ steps.release_versions.outputs.sequencer_version }}
        env:
          JAVA_OPTS: -Xmx2g -Dorg.gradle.daemon=false

      # - name: Set local zip paths (build from source)
      #   if: ${{ inputs.build_from_source }}
      #   id: set_paths
      #   run: |
      #     echo "local_tracer_zip_path=$GITHUB_WORKSPACE/tracer/plugins/build/distributions/linea-tracer-${{ steps.release_versions.outputs.arithmetization_version }}.zip" >> $GITHUB_OUTPUT
      #     echo "local_sequencer_zip_path=$GITHUB_WORKSPACE/besu-plugins/linea-sequencer/sequencer/build/distributions/linea-sequencer-${{ steps.release_versions.outputs.sequencer_version }}.zip" >> $GITHUB_OUTPUT

      - name: build the linea artifacts
        id: assemble
        uses: ./.github/actions/linea-besu-package/assemble
        with:
          release_tag_prefix: ${{ inputs.build_from_source && steps.release_versions.outputs.arithmetization_version || inputs.release_tag_prefix }}
          arithmetization_version: ${{ inputs.build_from_source && steps.release_versions.outputs.arithmetization_version || '' }}
          sequencer_version: ${{ inputs.build_from_source && steps.release_versions.outputs.sequencer_version || '' }}
          fetch_besu_fleet_plugin: ${{ inputs.with_besu_fleet_plugin }}
          fleet_github_app_id: ${{ secrets.FLEET_GITHUB_APP_ID }}
          fleet_github_app_private_key: ${{ secrets.FLEET_GITHUB_APP_PRIVATE_KEY }}

      - name: set up docker buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 #v3.11.1

      - name: set docker build args
        run: |
          echo "Building docker tag: ${{ steps.assemble.outputs.dockertag }}"
          echo "Building docker image: ${{ steps.assemble.outputs.dockerimage }}"

      - name: build the combined manifest
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 #v6.18.0
        env:
          DOCKER_BUILD_SUMMARY: false
        with:
          context: linea-besu-package/linea-besu/.
          platforms: linux/amd64
          provenance: false
          build-args: |
            VERSION=${{ steps.assemble.outputs.dockertag }}
            VCS_REF=${{ github.sha }}
            BUILD_DATE=${{ steps.assemble.outputs.build_date }}
          load: true
          push: false
          tags: |
            consensys/linea-besu-package:${{ steps.assemble.outputs.dockertag }}

      - name: Save Docker image as artifact
        run: |
          docker images
          docker save consensys/linea-besu-package:${{ steps.assemble.outputs.dockertag }} | gzip > linea-besu-package-image.tar.gz
        shell: bash

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: linea-besu-package
          path: linea-besu-package-image.tar.gz
          retention-days: 1
