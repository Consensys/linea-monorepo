name: get-has-changes-requiring-e2e-testing

permissions:
  contents: read

on:
  workflow_call:
    outputs:
      has-changes-requiring-e2e-testing:
        value: ${{ jobs.get-has-changes-requiring-e2e-testing.outputs.has_changes_requiring_e2e_testing }}

jobs:
  get-has-changes-requiring-e2e-testing:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-small
    outputs:
      has_changes_requiring_e2e_testing: ${{ steps.evaluate.outputs.result }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Filter for e2e-relevant paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 #v3.0.2
        id: filter
        with:
          base: ${{ github.ref }}
          list-files: json
          filters: |
            e2e:
              # Coordinator
              - 'coordinator/**/src/main/**'
              # JVM libs (shared)
              - 'jvm-libs/**/src/main/**'
              # Transaction exclusion API
              - 'transaction-exclusion-api/**/src/main/**'
              # Postman
              - 'postman/src/**'
              - 'postman/package.json'
              # Prover
              - 'prover/**/*.go'
              - 'prover/**/*.mod'
              - 'prover/**/*.sum'
              # SDK
              - 'sdk/**/src/**'
              - 'sdk/**/package.json'
              # TS libs (shared)
              - 'ts-libs/**/src/**'
              - 'ts-libs/**/package.json'
              # Config and infrastructure
              - 'config/**/*.toml'
              - 'docker/**'
              - '**/Dockerfile'
              - 'contracts/local-deployments-artifacts/**'
              # Linea besu package
              - 'linea-besu-package/versions.env'
              - 'linea-besu-package/scripts/assemble-packages.sh'
              # E2E tests themselves
              - 'e2e/src/**'
              - 'e2e/package.json'
              - '.nvmrc'
              - 'package.json'
              # Workflows
              - '.github/workflows/reuse-run-e2e-tests.yml'

      - name: Evaluate excluding test/doc files
        id: evaluate
        env:
          E2E_PATHS_MATCHED: ${{ steps.filter.outputs.e2e }}
          E2E_PATHS_FILES: ${{ steps.filter.outputs.e2e_files }}
        run: |
          if [[ "$E2E_PATHS_MATCHED" != "true" ]]; then
            echo "No e2e-relevant paths matched"
            echo "result=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Matched files: $E2E_PATHS_FILES"
          
          # Parse JSON array safely using jq
          mapfile -t FILES < <(echo "$E2E_PATHS_FILES" | jq -r '.[]')
          
          for file in "${FILES[@]}"; do
            # Skip unit test files EXCEPT those in e2e/src/ (e2e tests themselves)
            if [[ "$file" =~ \.test\.ts$ ]] && [[ ! "$file" =~ ^e2e/src/ ]]; then
              continue
            fi
            
            if [[ "$file" =~ \.spec\.ts$ ]] && [[ ! "$file" =~ ^e2e/src/ ]]; then
              continue
            fi
            
            if [[ "$file" =~ _test\.go$ ]]; then
              continue
            fi
            
            if [[ "$file" =~ Test\.kt$ ]]; then
              continue
            fi
            
            if [[ "$file" =~ Test\.java$ ]]; then
              continue
            fi
            
            # Skip doc files
            if [[ "$file" =~ \.(md|mdx)$ ]]; then
              continue
            fi
            
            echo "âœ“ e2e-relevant file: $file"
            echo "result=true" >> $GITHUB_OUTPUT
            exit 0
          done
          
          echo "Only test/doc files changed"
          echo "result=false" >> $GITHUB_OUTPUT
