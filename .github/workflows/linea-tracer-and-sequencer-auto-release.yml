# When a PR that updates besu or arithmetization in releases.versions.toml is merged to main,
# automatically trigger the tracer and sequencer release workflows with the updated versions.
name: Auto-release Tracer and Sequencer on releases.versions.toml change

permissions:
  contents: read
  actions: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'gradle/releases.versions.toml'

jobs:
  auto-release:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-small
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      
      - name: Parse release versions from releases.versions.toml
        id: release_versions
        uses: ./.github/actions/parse-release-versions

      - name: Trigger Linea Tracer Release
        run: |
          TRACER_TAG="linea-tracer-${{ steps.release_versions.outputs.arithmetization_version }}"
          echo "Triggering linea-tracer-plugin-release with release_tag=$TRACER_TAG"
          gh workflow run "linea-tracer-plugin-release.yml" \
            --ref main \
            -f release_tag="$TRACER_TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Linea Sequencer Release
        run: |
          SEQUENCER_TAG="linea-sequencer-${{ steps.release_versions.outputs.sequencer_version }}"
          echo "Triggering linea-sequencer-plugin-release with version=$SEQUENCER_TAG"
          gh workflow run "linea-sequencer-plugin-release.yml" \
            --ref main \
            -f release_tag="$SEQUENCER_TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
