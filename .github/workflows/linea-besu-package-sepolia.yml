name: linea-besu-package-sepolia

on:
  pull_request:
  push:
    branches:
      - main
    paths:
      # - 'linea-besu-package/versions/linea-sepolia.env'
      # - 'linea-besu-package/linea-besu/profiles/*-sepolia.toml'
      - 'linea-besu-package/'
      - '.github/actions/linea-besu-package/'
      - '.github/workflows/linea-besu-package/' # to be removed
      - '.github/workflows/linea-besu-package-sepolia.yml'
      - '.github/workflows/reuse-linea-besu-package-*.yml'

  workflow_call:
    outputs:
      workflow_run_id: 
        description: "the run id of the workflow"
        value: ${{ jobs.build-test-push.outputs.workflow_run_id }}
  workflow_dispatch:
    inputs:
      release_tag_prefix:
        description: 'Custom release tag prefix'
        required: false
        type: string
        default: ''

permissions:
  id-token: write  
  contents: read

jobs:
  filter-commit-changes:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-small
    name: Filter commit changes
    if: ${{ github.event_name != 'workflow_dispatch' }}
    outputs:
      linea-sepolia-env: ${{ steps.filter.outputs.linea-sepolia-env }}
      linea-sepolia-profiles: ${{ steps.filter.outputs.linea-sepolia-profiles }}
    steps:
      - name: Filter commit changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.ref }}
          list-files: "json"
          filters: |
            linea-sepolia-env:
              - 'linea-besu-package/versions/linea-sepolia.env'
            linea-sepolia-profiles:
              - 'linea-besu-package/linea-besu/profiles/*-sepolia.toml'

  echo-github-variables:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-small
    steps:
      - name: echo github variables
        run: |
          echo "github.run_id: ${{ github.run_id }}"
          echo "github.workflow: ${{ github.workflow }}"
          echo "github.ref: ${{ github.ref }}"

  build-test-push:
    # concurrency:
    #   group: build-test-push-${{ github.workflow }}-${{ github.ref }}
    #   cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}
    needs: [ filter-commit-changes ]
    if: ${{ always() }}
    uses: ./.github/workflows/reuse-linea-besu-package-build-test-push.yml
    with:
      linea_env: sepolia
      release_tag_prefix: ${{ inputs.release_tag_prefix }}
      run_test: true
      run_e2e_test: ${{ github.event_name == 'workflow_dispatch' || needs.filter-commit-changes.outputs.linea-sepolia-env == 'true' }}
      push_image: ${{ github.event_name == 'workflow_dispatch' || needs.filter-commit-changes.outputs.linea-sepolia-env == 'true' || needs.filter-commit-changes.outputs.linea-sepolia-profiles == 'true' }}
    secrets: inherit
