name: 'Setup nodes'
description: 'Setup nodejs'

inputs:
  pnpm-install-options:
    description: 'The options to pass to pnpm install'
    required: true
    default: '--frozen-lockfile --prefer-offline --ignore-scripts'

outputs:
  node-version:
    description: 'Resolved Node.js version'
    value: ${{ steps.versions.outputs.node }}
  pnpm-version:
    description: 'Resolved pnpm version'
    value: ${{ steps.versions.outputs.pnpm }}

runs:
  using: 'composite'
  steps:
    - uses: pnpm/action-setup@v4
      name: setup-pnpm

    - uses: actions/setup-node@v4
      name: setup-nodejs
      with:
        node-version-file: .nvmrc
        cache: 'pnpm'

    - id: versions
      name: Capture versions
      shell: bash
      run: |
        echo "node=$(node -v | sed 's/^v//')" >> "$GITHUB_OUTPUT"
        echo "pnpm=$(pnpm -v)" >> "$GITHUB_OUTPUT"

    # Configure pnpm for better caching
    - name: Configure pnpm
      shell: bash
      run: |
        pnpm config set store-dir ~/.pnpm-store
        pnpm config set side-effects-cache true
        pnpm config set side-effects-cache-readonly ${{ github.ref != 'refs/heads/main' && 'true' || 'false' }}

    # Parallel fetch all dependencies before install
    - name: Fetch dependencies
      shell: bash
      run: pnpm fetch ${{ inputs.pnpm-install-options }}

    - name: pnpm install
      run: pnpm i ${{ inputs.pnpm-install-options }}
      shell: bash
