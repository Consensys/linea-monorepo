---
name: 'assemble'
description: 'Composite action to assemble the artifacts for the targer environment'

inputs:
  fetch_besu_fleet_plugin:
    description: 'Fetch Besu Fleet plugin or not'
    required: false
    default: 'false'
  besu_fleet_plugin_version:
    description: 'Besu Fleet plugin version'
    required: false
  fleet_github_app_id:
    description: 'GitHub App ID to authenticate to besu-fleet-plugin repo'
    required: false
  fleet_github_app_private_key:
    description: 'GitHub App private key to authenticate to besu-fleet-plugin repo'
    required: false
  local_besu_version:
    description: 'Besu version when build from source, defined in gradle/libs.versions.toml'
    required: false
  local_arithmetization_version:
    description: 'Arithmetization version from local zip; if set, used instead of downloading from releases'
    required: false
  local_sequencer_version:
    description: 'Sequencer version from local zip; if set, used instead of downloading from releases'
    required: false

runs:
  using: "composite"
  steps:
    - name: Set local zip paths (build from source)
      if: ${{ inputs.local_besu_version != '' && inputs.local_arithmetization_version != '' && inputs.local_sequencer_version != '' }}
      id: set_local_zip_paths
      shell: bash
      run: |
        echo "local_tracer_zip_path=$GITHUB_WORKSPACE/tracer/plugins/build/distributions/linea-tracer-${{ inputs.local_arithmetization_version }}.zip" >> $GITHUB_OUTPUT
        echo "local_sequencer_zip_path=$GITHUB_WORKSPACE/besu-plugins/linea-sequencer/sequencer/build/distributions/linea-sequencer-${{ inputs.local_sequencer_version }}.zip" >> $GITHUB_OUTPUT

    - name: assemble the packages to linea-besu
      shell: bash
      env:
        ASSEMBLE_LOCAL_ZIPS: ${{ inputs.local_besu_version != '' && inputs.local_arithmetization_version != '' && inputs.local_sequencer_version != '' }}
        LOCAL_BESU_VERSION: ${{ inputs.local_besu_version }}
        LOCAL_TRACER_ZIP_PATH: ${{ steps.set_local_zip_paths.outputs.local_tracer_zip_path }}
        LOCAL_SEQUENCER_ZIP_PATH: ${{ steps.set_local_zip_paths.outputs.local_sequencer_zip_path }}
      run: |
        cd linea-besu-package
        if [[ "$ASSEMBLE_LOCAL_ZIPS" == "true" ]]; then
          BESU_VERSION="$LOCAL_BESU_VERSION" LOCAL_TRACER_ZIP_PATH="$LOCAL_TRACER_ZIP_PATH" LOCAL_SEQUENCER_ZIP_PATH="$LOCAL_SEQUENCER_ZIP_PATH" make assemble-local
        else
          make assemble
        fi
        mv ./tmp/besu ./linea-besu
    
    - name: generate token to fetch artifacts from private besu-fleet-plugin
      id: generate_token
      if: ${{ inputs.fetch_besu_fleet_plugin == 'true' }}
      uses: getsentry/action-github-app-token@v3
      with:
        private_key: ${{ inputs.fleet_github_app_private_key }}
        app_id: ${{ inputs.fleet_github_app_id }}

    - name: get plugins from private besu-fleet-plugin
      if: ${{ inputs.fetch_besu_fleet_plugin == 'true' }}
      uses: dsaltares/fetch-gh-release-asset@master
      with:
        repo: 'Consensys/besu-fleet-plugin'
        version: 'tags/${{ inputs.besu_fleet_plugin_version }}'
        target: './linea-besu-package/linea-besu/besu/plugins/besu-fleet-plugin-${{ inputs.besu_fleet_plugin_version }}.jar'
        file: 'besu-fleet-plugin-${{ inputs.besu_fleet_plugin_version }}.jar'
        token: ${{ steps.generate_token.outputs.token }}
    
    - name: show folder structure
      shell: bash
      run: |
        cd linea-besu-package
        sudo apt update
        sudo apt-get install --no-install-recommends --assume-yes tree
        tree .
