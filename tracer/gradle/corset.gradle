/*
 * Copyright Consensys Software Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
tasks.register('corsetExists') {
  dependsOn('installGoCorset')
  doLast {
    def result = exec {
      ignoreExitValue = true
      commandLine "go-corset", "--version"
    }
    if (result.getExitValue() != 0) {
      throw new GradleException('go-corset not found!')
    }
  }
}

ext {
  corsetVersion = project.hasProperty('corsetVersion')
    ? project.property('corsetVersion')
    : System.getenv().getOrDefault('CORSET_VERSION', "1.2.0-rc7")
}

tasks.register('installGoCorset') {
  description = 'Install go-corset'
  group = 'build'

  doLast {
    def corsetVersion = project.ext.corsetVersion
    def isWindows = System.getProperty('os.name').toLowerCase().contains('win')
    logger.lifecycle("Target version: $corsetVersion")
    if (corsetVersion.isEmpty()) {
      throw new GradleException("corsetVersion property is not set")
    }

    // Helper function to execute commands
    def runCommand = { String cmd, Boolean throwOnFailure = true ->
      def process
      if (isWindows) {
        process = ["cmd", "/c", cmd].execute()
      } else {
        process = cmd.execute()
      }
      def out = new StringBuilder()
      def err = new StringBuilder()
      process.consumeProcessOutput(out, err)
      def exitCode = process.waitFor()
      if (exitCode != 0 && throwOnFailure) {
        throw new GradleException("Command '$cmd' failed with exitCode=$exitCode error=$err")
      }
      return [exitCode, out.toString(), err.toString()]
    }

    // Check if go-corset exists
    def goCorsetExists = false
    try {
      def checkCmd = isWindows ? "where go-corset" : "which go-corset"
      def (exitCode, out, err) = runCommand(checkCmd, false)
      goCorsetExists = (exitCode == 0)
    } catch (Exception e) {
      logger.warn("Check command failed: ${e.message}")
      goCorsetExists = false
    }

    def installRequired = true

    if (goCorsetExists) {
      logger.lifecycle("go-corset found. Checking version...")
      def (exitCode, out, err) = runCommand("go-corset --version")
      def versionOutput = out.replace("go-corset", "").trim()
      if (versionOutput == corsetVersion) {
        logger.lifecycle("✓ go-corset $corsetVersion already installed")
        installRequired = false
      } else {
        logger.lifecycle("⚠ go-corset version mismatch: installed=$versionOutput expected=$corsetVersion")
      }
    } else {
      logger.lifecycle("go-corset not found in PATH")
    }

    if (installRequired) {
      logger.lifecycle("Installing go-corset@$corsetVersion...")
      runCommand("go install github.com/consensys/go-corset/cmd/go-corset@${corsetVersion}")
    }
  }
}

// Allowing overriding the default zkevm.bin files.
def ZKEVM_OSAKA_BIN = System.getenv("ZKEVM_OSAKA_BIN") ?: "zkevm_osaka.bin"

// Specify package to use for trace file
def TRACE_PKG = "net.consensys.linea.zktracer"

tasks.register('buildZkevmBins', Exec) {
  dependsOn('corsetExists')
  workingDir "${project.rootDir}/tracer-constraints/"
  // Specify input files so gradle knows when to rebuild.
  inputs.files(fileTree(workingDir).include('**/*.lisp'))
  // Specify output file so gradle knows when out-of-date.
  outputs.files(fileTree(workingDir).include(ZKEVM_OSAKA_BIN))
  // Sanity check executing this makes sense.
  doFirst {
    // sanity check target chain
    def chain = System.getProperty('blockchain')
    // note: null indicates the default (which is Linea).
    if (chain != null && chain != "Linea") {
      println("*** incorrect target chain (expected 'Linea' was '" + chain + "')\n\n")
      assert false
    }
  }
  // Make all forks
  commandLine 'make'
}

def lineaTracerProject = project(lineaTracerProjectPath)

// Task which generates the Trace.java interface using go-corset.
tasks.register('buildAllTracers', Exec) {
  group "Trace file(s) generation"
  dependsOn 'buildZkevmBins'
  // Specify where the trace files should be generated.
  def GENERATED_SRC_DIR = "${project.buildDir}/generated/gocorset/main/java/net/consensys/linea/zktracer"
  def TRACE_FILE = "$GENERATED_SRC_DIR/Trace.java"
  def OSAKA_TRACE_FILE = "$GENERATED_SRC_DIR/TraceOsaka.java"

  // Locate target files
  def traceJava = lineaTracerProject.file(TRACE_FILE)
  def traceOsakaJava = lineaTracerProject.file(OSAKA_TRACE_FILE)
  // Configure full paths for zkevm.bin files
  def zkevmOsakaBin = lineaTracerProject.file("${project.rootDir}/tracer-constraints/" + ZKEVM_OSAKA_BIN)
  // Generate trace interface and implementing classes
  doFirst {
    traceJava.parentFile.mkdirs()
  }
  commandLine 'go-corset', 'generate', '-p', TRACE_PKG, '-i', traceJava,
    '-o', traceOsakaJava, zkevmOsakaBin
}
