plugins {
  id "net.consensys.zkevm.kotlin-library-conventions"
  id 'java-test-fixtures'
}

dependencies {
  implementation(project(":jvm-libs:future-extensions"))
  implementation(project(":jvm-libs:kotlin-extensions"))
  api("io.vertx:vertx-pg-client")
  api("com.ongres.scram:common:2.1") {
    because("Vertx pg client fails without it")
  }
  api("com.ongres.scram:client:2.1") {
    because("Vertx pg client fails without it")
  }
  api("org.postgresql:postgresql:42.6.0")
  api("org.flywaydb:flyway-core:8.4.3")
  api("org.slf4j:slf4j-api:1.7.30") {
    because("Flyway DB and other dependencies use SLF4J")
  }

  testImplementation(project(":coordinator:persistence:db-common"))
  testImplementation testFixtures(project(':jvm-libs:generic:extensions:kotlin'))

  testFixturesImplementation(project(":coordinator:core"))
  testFixturesApi(platform("org.junit:junit-bom:${libs.versions.junit.get()}"))
  testFixturesApi("io.vertx:vertx-junit5:${libs.versions.vertx.get()}")
}

sourceSets {
  integrationTest {
    kotlin {
      compileClasspath += main.output
      runtimeClasspath += main.output
    }
    compileClasspath += sourceSets.main.output + sourceSets.main.compileClasspath + sourceSets.test.compileClasspath
    runtimeClasspath += sourceSets.main.output + sourceSets.main.runtimeClasspath + sourceSets.test.runtimeClasspath
  }
}

task integrationTest(type: Test) {
  test ->
    description = "Runs integration tests."
    group = "verification"
    useJUnitPlatform()

    classpath = sourceSets.integrationTest.runtimeClasspath
    testClassesDirs = sourceSets.integrationTest.output.classesDirs

    dependsOn(":localStackComposeUp")
}


